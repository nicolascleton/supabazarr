version: "3.8"

services:
  supabazarr:
    image: ghcr.io/nicolascleton/supabazarr:latest
    container_name: supabazarr
    restart: unless-stopped
    environment:
      - TZ=Europe/Paris
      - PUID=1000
      - PGID=1000
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - DEVICE_UUID=${DEVICE_UUID:-}
      - HOSTNAME=${HOSTNAME:-jellypi}
      - MEDIA_STACK_PATH=/media-stack
    volumes:
      # Monter le dossier media-stack en lecture seule
      - ./:/media-stack:ro
      # Persister l'UUID du device
      - supabazarr_data:/etc/supabazarr
      # Logs
      - ./logs/supabazarr:/var/log/supabazarr
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.25'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "python", "-c", "import os; exit(0 if os.path.exists('/etc/supabazarr/device_uuid') else 1)"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  supabazarr_data:
